name: compliance


on:
  push:
    branches:
      - josh/*
  pull_request:

jobs:
  compliance:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Setup PDM
        run: curl -sSL https://raw.githubusercontent.com/pdm-project/pdm/main/install-pdm.py | python3 -

      - name: "Setup Node.js"
        uses: "actions/setup-node@v3"
        with:
          node-version: 18.15

      - name: Checkout bundler spec test
        uses: actions/checkout@v3
        with:
          repository: alchemyplatform/bundler-spec-tests
          ref: master
          path: ./bundler-spec-tests
          submodules: true

      - name: Setup bundler spec test
        working-directory: ./bundler-spec-tests
        run: |
          pdm install && \
          cd @account-abstraction && \
          yarn install --frozen-lockfile && \
          yarn compile && \
          cd ../spec && \
          yarn install --frozen-lockfile && \
          yarn build

      - name: Install Geth
        run: |
          sudo add-apt-repository -y ppa:ethereum/ethereum && \
          sudo apt-get update && \
          sudo apt-get install ethereum

      - name: Run Geth
        run: |
          geth \
          --verbosity 1 \
          --http.vhosts '*,localhost,host.docker.internal' \
          --http \
          --http.api eth,net,web3,debug \
          --http.corsdomain '*' \
          --http.addr "0.0.0.0" \
          --nodiscover --maxpeers 0 --mine \
          --networkid 1337 \
          --dev \
          --allow-insecure-unlock \
          --rpc.allow-unprotected-txs \
          --miner.gaslimit 12000000 &

      - name: Install protobuf
        run: sudo apt-get install -y protobuf-compiler

      - name: Install toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.71.0

      - name: Deploy ERC-4337 contracts
        working-directory: ./bundler-spec-tests
        run: |
          cd @account-abstraction && \
          yarn deploy --network localhost

      - name: Fund bundler
        run: |
          geth \
          --exec "eth.sendTransaction({from: eth.accounts[0], to: \"0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266\", value: web3.toWei(10000, \"ether\")})" \
          attach http://localhost:8545/

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1

      - name: Build Rundler
        run: cargo build

      - name: Run Rundler
        run: | 
          cargo run node &
          sleep 30s
        env:
          BUILDER_PRIVATE_KEY: "0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80"
          ENTRY_POINTS: "0x5FF137D4b0FDCD49DcA30c7CF57E578a026d2789"
          NODE_HTTP: http://localhost:8545
          RPC_API: eth,debug
          RUST_LOG: debug

      - name: show listening addresses
        run: sudo lsof -i -P -n | grep LISTEN

      - name: Run test
        working-directory: ./bundler-spec-tests
        run: pdm run pytest -rA -W ignore::DeprecationWarning --url http://localhost:3000 --entry-point 0x5FF137D4b0FDCD49DcA30c7CF57E578a026d2789 --ethereum-node http://localhost:8545/
